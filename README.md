# Fit2Go - Enhanced Fitness Tracking for Flexispot Sit2Go

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**❗ Important Note: The code in this repository was largely generated with the assistance of Google's Gemini AI based on user requests and discussions.**

## Overview

Fit2Go is custom firmware developed for the M5Stack Core (ESP32) designed to enhance the [Flexispot Fitness Chair F1C (a.k.a. Sit2Go)](https://www.flexispot.com/sit2go-2-in-1-fitness-chair-eco) fitness chair. It adds comprehensive fitness tracking, data logging, and network connectivity features, allowing you to monitor your pedaling activity while you work or relax.

This project reads the pulse signals generated by the chair's pedal rotation sensor and translates them into meaningful fitness metrics.

## Features

* **Pulse Counting:** Accurately counts pedal rotation pulses using the ESP32's PCNT peripheral.
* **Real-time Metrics:** Calculates and displays:
    * Revolutions Per Minute (RPM)
    * Speed (km/h)
    * Session Time
    * Session Distance (km)
    * Session Calories (kcal)
* **Cumulative Tracking:** Keeps track of total time, distance, and calories burned across sessions.
* **SD Card Logging:**
    * Saves the latest cumulative data to `/cumulative_latest.json`.
    * Appends historical snapshots (timestamp, cumulative data) to `/cumulative_history.jsonl` (JSON Lines format) just before sleeping.
* **On-Device Display:** Shows current metrics, session stats, cumulative totals, and system status (IDLE, TRACKING, PAUSED/STOPPING) on the M5Stack's screen.
* **Wi-Fi Connectivity:** Connects to your Wi-Fi network using credentials stored in NVS or configured via SD card (`/config.json`).
* **AP Mode Configuration:** If no Wi-Fi credentials are found in NVS, or triggered manually after a scan, it starts an Access Point (AP) mode with a web portal (`http://192.168.4.1`) for easy Wi-Fi setup. Scan results are shown on the web page.
* **NTP Time Synchronization:** Automatically synchronizes the internal clock with an NTP server (using JST by default) when connected to Wi-Fi, providing accurate timestamps for history logs. Uses `millis()` as a fallback when offline.
* **Data Publishing:** Sends calculated metrics (current, session, cumulative) as a JSON payload via HTTP POST to a user-configurable endpoint URL **only during active tracking** (`TRACKING_DISPLAY` state).
* **Refined Inactivity Handling:**
    * Enters a `STOPPING` (Paused) state after 3 seconds of inactivity (`TIMER_STOP_DELAY_MS`). Data publishing is paused in this state.
    * Enters deep sleep mode after a longer period of total inactivity (approx. 63 seconds - `SLEEP_TIMEOUT_MS`) to conserve power.
    * Wakes up automatically when pedaling resumes.
* **Drive Type Configuration:** Supports two operation modes:
    * `TIMER_DRIVEN`: Updates metrics and publishes data at fixed intervals
    * `EVENT_DRIVEN`: Updates metrics and publishes data on pulse events
    * Configurable via `"drive_type": "timer"` or `"drive_type": "event"` in `config.json`

## Hardware Required

* **Flexispot Sit2Go Fitness Chair:** (Specifically tested/intended for F1C model).
* **M5Stack Core:** (Tested with M5Stack Basic Core, likely compatible with other Core models).
* **Micro SD Card:** For storing configuration and logged data. Formatted as FAT32.
* **Connection Wire:** To connect the pulse signal output from the Sit2Go's sensor to the specified GPIO pin on the M5Stack. (See `config.hpp` for `PULSE_INPUT_PIN`, default is GPIO 36). **Note:** This requires accessing the chair's internal wiring. Proceed with caution.

## Software Dependencies

* [PlatformIO IDE](https://platformio.org/)
* [Espressif 32 Platform](https://registry.platformio.org/platforms/platformio/espressif32) for PlatformIO
* Libraries (managed by PlatformIO via `platformio.ini`):
    * M5Stack Library (`m5stack/M5Stack`)
    * ArduinoJson (`bblanchon/ArduinoJson`)
    * ESPAsyncWebServer (`ottowinter/ESPAsyncWebServer-esphome`)
    * AsyncTCP (`AsyncTCP`)
    * (Standard ESP32 Arduino libraries: FS, SD, WiFi, HTTPClient, Preferences, time, etc.)

## Installation & Setup

1.  **Clone Repository:** `git clone https://github.com/[Your GitHub Username]/fit2go.git` (Replace with your actual repo URL)
2.  **Open in PlatformIO:** Open the cloned `fit2go` folder in VS Code with the PlatformIO extension installed.
3.  **Build & Upload:** Use PlatformIO controls (Build, Upload) to compile and flash the firmware to your M5Stack.
4.  **Hardware Connection:** Connect the pulse output signal from the Sit2Go sensor to the GPIO pin defined by `PULSE_INPUT_PIN` in `include/config.hpp` (default is GPIO 36). Ensure a common ground connection between the Sit2Go's sensor circuit and the M5Stack.
5.  **Prepare SD Card:**
    * Format a Micro SD card as FAT32.
    * Create a file named `config.json` in the root directory of the SD card.
6.  **Configure `config.json`:**
    * Edit the `config.json` file on the SD card with your settings:

    ```json
    {
      "endpoint_url": "http://your-server.com/api/data",  // HTTP or HTTPS
      "drive_type": "timer",
      "networks": [
        {
          "ssid": "YourHomeSSID",
          "password": "YourHomePassword"
        },
        {
          "ssid": "YourOfficeSSID",
          "password": "YourOfficePassword"
        }
      ]
    }
    ```
    * `endpoint_url`: The URL where fitness data will be POSTed
        * Supports both HTTP (`http://...`) and HTTPS (`https://...`) URLs
        * For HTTPS, requires root_ca.pem file (see below)
    * `drive_type`: Operation mode - "timer" or "event" (optional, defaults to "timer")
    * `networks`: Array of Wi-Fi networks to try connecting to
    
7.  **For HTTPS Support:**
    * Required only when using HTTPS in endpoint_url
    * Create a file named `root_ca.pem` in the root directory of the SD card
    * Copy your server's root CA certificate content into this file
    * The device will automatically use this certificate for HTTPS connections

8.  **Insert SD Card & Boot:** Insert the SD card into the M5Stack and power it on.

## Wi-Fi Configuration Details

The firmware attempts to connect to Wi-Fi in the following order:

1.  **NVS:** Checks for credentials saved previously (e.g., via AP mode).
2.  **SD Card (`config.json`):** If no valid NVS credentials are found, it tries the first network listed in `/config.json`. If successful, these credentials are saved to NVS for future use.
3.  **AP Mode:** If no credentials are found in NVS upon entering the Wi-Fi setup screen (Trigger 1), or if triggered manually after a scan (Trigger 2: Wi-Fi Setup Screen -> BtnA Scan -> Scan Result Screen -> BtnB), the device enters AP Mode:
    * Connect your phone/computer to the Wi-Fi network named "M5Stack_Setup".
    * Open a web browser; it should redirect to `http://192.168.4.1` (or navigate manually).
    * The page will display nearby networks scanned by the M5Stack.
    * Select or type your network SSID, enter the password, and click "Save & Connect".
    * The credentials will be saved to NVS, and the M5Stack will restart and attempt to connect.

## Usage

* **Automatic Start:** Simply start pedaling. The display will switch from the IDLE screen to the TRACKING screen (`TRACKING_DISPLAY` state), and the session timer and data publishing will begin (if Wi-Fi is connected).
* **Automatic Pause/Stop:**
    1. Stop pedaling.
    2. After **3 seconds** (`TIMER_STOP_DELAY_MS`), the session timer on the display will pause, data publishing stops, and the device enters the `STOPPING` state (display shows "PAUSED").
    3. If you resume pedaling while in the `STOPPING` state (within approx. 60 seconds of stopping), the device returns to the `TRACKING_DISPLAY` state, and the timer and data publishing resume.
    4. If you remain inactive for the full **63 seconds** (`SLEEP_TIMEOUT_MS` since the *last pedal stroke*), the device transitions from `STOPPING` to the `IDLE_DISPLAY` state.
    5. While in the `IDLE_DISPLAY` state, if inactivity continues, the device will enter deep sleep after the `SLEEP_TIMEOUT_MS` is met (relative to the last pedal stroke or since boot if never pedaled). History data is appended just before sleeping.
* **Wake Up:** Start pedaling again to wake the device from deep sleep. It will boot into the `IDLE_DISPLAY` state.

* **Button Functions (Default):**
    * **BtnA (Left):**
        * In `WIFI_SETUP` screen: Initiates Wi-Fi Scan -> `WIFI_SCANNING` state.
        * In `WIFI_SCANNING` screen: (Future TODO: Select scanned network).
    * **BtnB (Middle):**
        * In `WIFI_SCANNING` screen: Starts AP Config Mode -> `WIFI_AP_CONFIG` state.
        * Long press (1 sec) in `TRACKING_DISPLAY` or `STOPPING` state: Resets current session data and returns to `IDLE_DISPLAY`.
        * Press in `IDLE_DISPLAY` screen: Enters `WIFI_SETUP` screen.
    * **BtnC (Right):**
        * In `IDLE_DISPLAY`, `TRACKING_DISPLAY`, or `STOPPING` state: Enters `WIFI_SETUP` screen.
        * In `WIFI_SETUP`, `WIFI_SCANNING`, or `WIFI_AP_CONFIG` state: Returns to the previous main screen (IDLE, TRACKING, or STOPPING). Cancels AP mode if active.

## Data Formats

* **`/cumulative_latest.json`:** Stores the most recent cumulative totals.
    ```json
    {"time_ms": 1234567890, "dist_km": 123.45, "cal_kcal": 1234.5}
    ```
* **`/cumulative_history.jsonl`:** Stores historical snapshots as JSON objects, one per line (JSON Lines format). Appended just before deep sleep.
    ```json
    {"timestamp_ms":1678886400000,"time_ms":10000,"dist_km":1.2,"cal_kcal":50.1}
    {"timestamp_ms":1678887000000,"time_ms":25000,"dist_km":3.5,"cal_kcal":120.3}
    ```
    (`timestamp_ms` is Unix epoch milliseconds (UTC) if NTP synced, otherwise `millis()` since boot).
* **HTTP/HTTPS POST Payload:** Data sent to the `endpoint_url` (only during `TRACKING_DISPLAY` state).
    ```json
    {
      "timestamp_ms": 1678886400000,
      "session_time_s": 600.5,
      "session_dist_km": 2.1,
      "session_cal_kcal": 55.2,
      "rpm": 65.0,
      "speed_kmh": 17.2,
      "mets": 4.0,
      "total_time_s": 1234567.890,
      "total_dist_km": 123.45,
      "total_cal_kcal": 1234.5,
      "device_id": "AABBCCDDEEFF"
    }
    ```
    `timestamp_ms` is Unix epoch milliseconds (UTC) if NTP synced, otherwise `millis()` since boot.

## License

This project is licensed under the **MIT License**. See the [LICENSE](LICENSE) file in the repository root for the full license text.

## Disclaimer

This is an unofficial, community-driven project and is **not affiliated with, endorsed by, or sponsored by Flexispot**.

Modifying electronic devices and fitness equipment involves risks. Accessing internal wiring or modifying the original hardware may void your product warranty and could potentially damage the device or cause injury if not done carefully. The author(s) of this firmware assume no responsibility for any damage to hardware or any personal injury that may result from using or attempting to use this firmware or associated modification instructions.

**Use this firmware and perform any hardware modifications entirely at your own risk.**