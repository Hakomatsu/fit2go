# Fit2Go - Enhanced Fitness Tracking for Flexispot Sit2Go

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT) 

**â— Important Note: The code in this repository was largely generated with the assistance of Google's Gemini AI based on user requests and discussions.**

## Overview

Fit2Go is custom firmware developed for the M5Stack Core (ESP32) designed to enhance the [Flexispot Fitness Chair F1C (a.k.a. Sit2Go)](https://www.flexispot.com/sit2go-2-in-1-fitness-chair-eco) fitness chair. It adds comprehensive fitness tracking, data logging, and network connectivity features, allowing you to monitor your pedaling activity while you work or relax.

This project reads the pulse signals generated by the chair's pedal rotation sensor and translates them into meaningful fitness metrics.

## Features

* **Pulse Counting:** Accurately counts pedal rotation pulses using the ESP32's PCNT peripheral.
* **Real-time Metrics:** Calculates and displays:
    * Revolutions Per Minute (RPM)
    * Speed (km/h)
    * Session Time
    * Session Distance (km)
    * Session Calories (kcal)
* **Cumulative Tracking:** Keeps track of total time, distance, and calories burned across sessions.
* **SD Card Logging:**
    * Saves the latest cumulative data to `/cumulative_latest.json`.
    * Appends historical snapshots (timestamp, cumulative data) to `/cumulative_history.jsonl` (JSON Lines format) for detailed tracking.
* **On-Device Display:** Shows current metrics, session stats, cumulative totals, and system status on the M5Stack's screen.
* **Wi-Fi Connectivity:** Connects to your Wi-Fi network using credentials stored in NVS or configured via SD card.
* **AP Mode Configuration:** If no Wi-Fi credentials are found in NVS, or triggered manually, it starts an Access Point (AP) mode with a web portal (`http://192.168.4.1`) to allow easy Wi-Fi setup via a phone or computer. Scan results from the M5Stack are shown on the web page.
* **NTP Time Synchronization:** Automatically synchronizes the internal clock with an NTP server (using JST by default) when connected to Wi-Fi, providing accurate timestamps for history logs. Uses `millis()` as a fallback when offline.
* **Data Publishing:** Sends calculated metrics (current, session, cumulative) as a JSON payload via HTTP POST to a user-configurable endpoint URL.
* **Deep Sleep:** Enters deep sleep mode after a period of inactivity to conserve power, waking up automatically when pedaling resumes. History data is appended before sleeping.

## Hardware Required

* **Flexispot Sit2Go Fitness Chair:** The target device.
* **M5Stack Core:** (Tested with M5Stack Basic Core, likely compatible with other Core models).
* **Micro SD Card:** For storing configuration and logged data. Formatted as FAT32.
* **Connection Wire:** To connect the pulse signal output from the Sit2Go's sensor to the specified GPIO pin on the M5Stack. (See `config.hpp` for `PULSE_INPUT_PIN`). **Note:** This requires accessing the chair's internal wiring. Proceed with caution.

## Software Dependencies

* [PlatformIO IDE](https://platformio.org/)
* [Espressif 32 Platform](https://registry.platformio.org/platforms/platformio/espressif32) for PlatformIO
* Libraries (managed by PlatformIO via `platformio.ini`):
    * M5Stack Library
    * ArduinoJson
    * ESPAsyncWebServer
    * AsyncTCP
    * (Standard ESP32 Arduino libraries: FS, SD, WiFi, HTTPClient, Preferences, time, etc.)

## Installation & Setup

1.  **Clone Repository:** `git clone https://github.com/[Your GitHub Username]/fit2go.git`
2.  **Open in PlatformIO:** Open the cloned `fit2go` folder in VS Code with the PlatformIO extension installed.
3.  **Build & Upload:** Use PlatformIO controls (Build, Upload) to compile and flash the firmware to your M5Stack.
4.  **Hardware Connection:** Connect the pulse output signal from the Sit2Go sensor to the GPIO pin defined by `PULSE_INPUT_PIN` in `include/config.hpp` (default is GPIO 36). Ensure a common ground connection between the Sit2Go's sensor circuit and the M5Stack.
5.  **Prepare SD Card:**
    * Format a Micro SD card as FAT32.
    * Create a file named `config.json` in the root directory of the SD card.
6.  **Configure `config.json`:**
    * Edit the `config.json` file on the SD card with your Wi-Fi details and data endpoint URL. Use the following structure:

    ```json
    {
      "endpoint_url": "[http://your-server.com/api/data](http://your-server.com/api/data)",
      "networks": [
        {
          "ssid": "YourHomeSSID",
          "password": "YourHomePassword"
        },
        {
          "ssid": "YourOfficeSSID",
          "password": "YourOfficePassword"
        },
        {
          "ssid": "OpenWiFi",
          "password": null
        }
      ]
    }
    ```
    * `endpoint_url`: The URL where fitness data will be POSTed.
    * `networks`: An array of Wi-Fi networks. The firmware will try connecting to these if no valid NVS credentials are found. The password can be `null` or `""` for open networks.
7.  **Insert SD Card & Boot:** Insert the SD card into the M5Stack and power it on.

## Wi-Fi Configuration Details

The firmware attempts to connect to Wi-Fi in the following order:

1.  **NVS:** Checks for credentials saved previously (e.g., via AP mode).
2.  **SD Card (`config.json`):** If no valid NVS credentials are found, it tries the first network listed in `/config.json`. If successful, these credentials are saved to NVS for future use.
3.  **AP Mode:** If no credentials are found in NVS upon entering the Wi-Fi setup screen (Trigger 1), or if triggered manually after a scan (Trigger 2: Wi-Fi Setup Screen -> BtnA Scan -> Scan Result Screen -> BtnB), the device enters AP Mode:
    * Connect your phone/computer to the Wi-Fi network named "M5Stack_Setup".
    * Open a web browser; it should redirect to `http://192.168.4.1` (or navigate manually).
    * The page will display nearby networks scanned by the M5Stack.
    * Select or type your network SSID, enter the password, and click "Save & Connect".
    * The credentials will be saved to NVS, and the M5Stack will restart and attempt to connect.

## Usage

* **Automatic Start:** Simply start pedaling. The display will switch from the IDLE screen to the TRACKING screen, and the session timer will begin.
* **Automatic Stop:** Stop pedaling. After a short delay (`TIMER_STOP_DELAY_MS`), the session timer pauses (though metrics like RPM/Speed go to zero sooner). After a longer timeout (`SLEEP_TIMEOUT_MS`), the session ends, cumulative data is saved to SD, history is appended, and the device enters deep sleep.
* **Wake Up:** Start pedaling again to wake the device from deep sleep.
* **Button Functions (Default):**
    * **BtnA (Left):** In Wi-Fi Setup screen: Initiates Wi-Fi Scan. In Scan Result screen: (TODO: Select Network).
    * **BtnB (Middle):** In Wi-Fi Scan Result screen: Starts AP Config Mode. Long press in Tracking screen: Resets current session data. Press in Idle screen: Enters Wi-Fi Setup.
    * **BtnC (Right):** Enters/Exits Wi-Fi Setup/Scan/AP modes.

## Data Formats

* **`/cumulative_latest.json`:** Stores the most recent cumulative totals.
    ```json
    {"time_ms": 1234567890, "dist_km": 123.45, "cal_kcal": 1234.5}
    ```
* **`/cumulative_history.jsonl`:** Stores historical snapshots as JSON objects, one per line (JSON Lines format).
    ```json
    {"timestamp_ms":1678886400000,"time_ms":10000,"dist_km":1.2,"cal_kcal":50.1}
    {"timestamp_ms":1678887000000,"time_ms":25000,"dist_km":3.5,"cal_kcal":120.3}
    ```
    (`timestamp_ms` is Unix epoch milliseconds (UTC) if NTP synced, otherwise `millis()` since boot).
* **HTTP POST Payload:** Data sent to the `endpoint_url`.
    ```json
    {
      "session_time_s": 600.5,
      "session_dist_km": 2.1,
      "session_cal_kcal": 55.2,
      "rpm": 65.0,
      "speed_kmh": 17.2,
      "mets": 4.0, // Note: METs calculation might be basic
      "total_time_s": 1234567.890,
      "total_dist_km": 123.45,
      "total_cal_kcal": 1234.5,
      "device_id": "AABBCCDDEEFF" // ESP32 Chip ID
    }
    ```

## License

This project is licensed under the **MIT License**. See the [LICENSE](LICENSE) file for details.